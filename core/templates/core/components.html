{% extends 'main.html' %}
{% block content %}

<div class="components-container">
  <h2 class="components-title">Browse Components</h2>
  <div class="components-buttons" id="component-buttons">
    <button class="components-btn" data-type="cpu">CPU</button>
    <button class="components-btn" data-type="gpu">GPU</button>
    <button class="components-btn" data-type="ram">RAM</button>
    <button class="components-btn" data-type="motherboard">Motherboard</button>
    <button class="components-btn" data-type="psu">PSU</button>
    <button class="components-btn" data-type="ssdstorage">SSD Storage</button>
    <button class="components-btn" data-type="hddstorage">HDD Storage</button>
    <button class="components-btn" data-type="case">Case</button>
    <button class="components-btn" data-type="cpucooler">CPU Cooler</button>
  </div>
  <div class="components-list" id="components-list"></div>
</div>

<script>
function fetchComponents(type) {
    // Map button type to correct API endpoint
    const endpointMap = {
        cpu: 'cpus',
        gpu: 'gpus',
        ram: 'ram',
        motherboard: 'motherboards',
        psu: 'power-supplies',
        ssdstorage: 'ssdstorage',
        hddstorage: 'hddstorage',
        case: 'cases',
        cpucooler: 'coolers'
    };
    let url = `/api/${endpointMap[type]}/`;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('components-list');
            const grid = document.createElement('div');
            grid.className = 'component-grid';
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'component-card';
                card.innerHTML = `
                  <div class="card-title">${item.name ?? ''}</div>
                  <div class="card-desc">${(item.description ?? '').toString().slice(0, 140)}</div>
                  <div class="card-price">â‚¹${item.price ?? 0}</div>
                  <button type="button" class="card-pick" data-type="${type}" data-id="${item.id}">Add to Cart</button>
                `;
                grid.appendChild(card);
            });
            container.innerHTML = '';
            container.appendChild(grid);
            container.querySelectorAll('.card-pick').forEach(btn => {
                btn.addEventListener('click', () => addToCart(btn.getAttribute('data-type'), btn.getAttribute('data-id')));
            });
        });
}

function addToCart(componentType, objectId) {
    fetch('/api/add-to-cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '{{ csrf_token }}'
        },
        body: JSON.stringify({component_type: componentType, object_id: objectId})
    })
    .then(response => response.json())
    .then(data => {
        if (window.showToast) { window.showToast('Added to cart!', 'success'); } else { alert('Added to cart!'); }
    });
}

// Auto-fetch based on URL parameter
window.onload = function() {
    const params = new URLSearchParams(window.location.search);
    const type = params.get('type');
    if (type) {
        fetchComponents(type);
    }
    // Add event listeners to component buttons
    document.querySelectorAll('.components-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            fetchComponents(this.getAttribute('data-type'));
        });
    });
};
</script>

{% endblock content %}
